<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SiSocial</title>

<link rel="icon" href="icon.png.PNG" type="image/png">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#111;color:#fff}
header{background:#222;padding:10px;text-align:center}
input,button,textarea{width:100%;margin:6px 0;padding:8px}
button{cursor:pointer}
.hidden{display:none}
.post{background:#222;padding:10px;margin:10px 0}
img{max-width:100%;border-radius:6px}
.like{color:#f44;cursor:pointer}
.user{cursor:pointer;color:#0af}
</style>
</head>

<body>

<header>
<h2>SiSocial</h2>
</header>

<div id="auth">
<input id="user" placeholder="Usuário">
<input id="pass" type="password" placeholder="Senha">
<button onclick="register()">Criar conta</button>
<button onclick="login()">Entrar</button>
</div>

<div id="app" class="hidden">

<p>Logado como <b id="me"></b></p>
<button onclick="logout()">Trocar usuário</button>

<h3>Novo post</h3>
<input type="file" accept="image/*" onchange="loadImage(event)">
<img id="preview">
<button onclick="post()">Postar</button>

<h3>Feed</h3>
<div id="feed"></div>

<h3>Usuários</h3>
<div id="users"></div>

<h3>Chat</h3>
<div id="chat"></div>
<input id="msg">
<button onclick="sendMsg()">Enviar</button>

</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyClDT4Yl4nSOGLOR5sVXlnaf9pwnYjZHAw",
  authDomain: "sisocial.firebaseapp.com",
  projectId: "sisocial"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;
let currentImage = null;
let chatWith = null;

function register(){
  const u=user.value,p=pass.value;
  if(!u||!p)return alert("Preencha tudo");
  db.collection("users").doc(u).get().then(d=>{
    if(d.exists) return alert("Usuário existe");
    db.collection("users").doc(u).set({pass:p,following:[]});
    currentUser=u; start();
  });
}

function login(){
  const u=user.value,p=pass.value;
  db.collection("users").doc(u).get().then(d=>{
    if(!d.exists||d.data().pass!==p) return alert("Erro");
    currentUser=u; start();
  });
}

function logout(){location.reload();}

function start(){
  auth.classList.add("hidden");
  app.classList.remove("hidden");
  me.innerText=currentUser;
  loadUsers(); loadFeed(); loadChat();
}

function loadUsers(){
  users.innerHTML="";
  db.collection("users").get().then(s=>{
    s.forEach(d=>{
      if(d.id!==currentUser){
        users.innerHTML+=`<div class="user" onclick="follow('${d.id}')">@${d.id}</div>`;
      }
    });
  });
}

function follow(u){
  const ref=db.collection("users").doc(currentUser);
  ref.update({following:firebase.firestore.FieldValue.arrayUnion(u)});
  loadFeed();
}

function loadImage(e){
  const r=new FileReader();
  r.onload=()=>{preview.src=r.result; currentImage=r.result;}
  r.readAsDataURL(e.target.files[0]);
}

function post(){
  if(!currentImage)return alert("Imagem obrigatória");
  db.collection("posts").add({
    user:currentUser,
    img:currentImage,
    likes:[],
    at:Date.now()
  });
  preview.src=""; currentImage=null;
  loadFeed();
}

function loadFeed(){
  feed.innerHTML="";
  db.collection("users").doc(currentUser).get().then(u=>{
    const following=u.data().following;
    db.collection("posts").orderBy("at","desc").get().then(s=>{
      s.forEach(d=>{
        const p=d.data();
        if(following.includes(p.user)||p.user===currentUser){
          feed.innerHTML+=`
          <div class="post">
            <b>${p.user}</b><br>
            <img src="${p.img}">
            <div class="like" onclick="like('${d.id}')">❤️ ${p.likes.length}</div>
            <button onclick="openChat('${p.user}')">Chat</button>
          </div>`;
        }
      });
    });
  });
}

function like(id){
  const ref=db.collection("posts").doc(id);
  ref.update({likes:firebase.firestore.FieldValue.arrayUnion(currentUser)});
  loadFeed();
}

function openChat(u){chatWith=u; loadChat();}

function loadChat(){
  chat.innerHTML="";
  if(!chatWith)return;
  db.collection("chats")
  .where("users","array-contains",currentUser)
  .get().then(s=>{
    s.forEach(d=>{
      const m=d.data();
      if(m.users.includes(chatWith)){
        chat.innerHTML+=`<div><b>${m.from}:</b> ${m.text}</div>`;
      }
    });
  });
}

function sendMsg(){
  if(!chatWith)return;
  db.collection("chats").add({
    users:[currentUser,chatWith],
    from:currentUser,
    text:msg.value,
    at:Date.now()
  });
  msg.value=""; loadChat();
}
</script>

</body>
</html>